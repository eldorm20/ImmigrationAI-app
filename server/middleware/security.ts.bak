import { Request, Response, NextFunction } from "express";
import helmet from "helmet";
import cors from "cors";
import rateLimit from "express-rate-limit";
import { logger } from "../lib/logger";

// ============================================
// CORS CONFIGURATION
// ============================================
function getAllowedOrigins(): string[] {
  if (!process.env.ALLOWED_ORIGINS) {
    const defaults = [
      "http://localhost:5000",
      "http://localhost:3000",
      "http://127.0.0.1:5000",
    ];

    if (process.env.NODE_ENV === "production") {
      logger.warn("ALLOWED_ORIGINS not set in production, using defaults", defaults);
    }

    return defaults;
  }

  return process.env.ALLOWED_ORIGINS.split(",").map((o) => o.trim());
}

const allowedOrigins = getAllowedOrigins();
logger.info({ allowedOrigins }, "CORS configured");

export const corsMiddleware = cors({
  origin: function (origin, callback) {
    // Allow requests with no origin (e.g. curl, same-origin file requests)
    if (!origin || origin === "null") {
      return callback(null, true);
    }

    try {
      const normalizedOrigin = origin.toLowerCase();

      const isAllowed = allowedOrigins.some((allowed) => {
        const normalizedAllowed = allowed.toLowerCase();
        if (normalizedAllowed === normalizedOrigin) return true;

        // Wildcard support: e.g. *.example.com
        if (normalizedAllowed.includes("*")) {
          const pattern = new RegExp(
            "^" + normalizedAllowed.replace(/\./g, "\\.").replace(/\*/g, ".*") + "$"
          );
          return pattern.test(normalizedOrigin);
        }

        return false;
      });

      if (isAllowed) {
        return callback(null, true);
      }

      logger.warn({ origin }, "CORS origin not allowed");
      // In production, consider rejecting; to avoid accidental blocking allow it
      if (process.env.NODE_ENV === "production") {
        // allow anyway (safer for deployment) — change to callback(new Error(...)) to enforce
        return callback(null, true);
      } else {
        return callback(new Error("Not allowed by CORS"));
      }
    } catch (err) {
      logger.error({ err, origin }, "Error in CORS origin check");
      return callback(new Error("CORS check failed"));
    }
  },
  credentials: true,
  methods: ["GET", "HEAD", "PUT", "PATCH", "POST", "DELETE", "OPTIONS"],
  allowedHeaders: [
    "Content-Type",
    "Authorization",
    "X-Requested-With",
    "Accept",
    "Accept-Language",
    "Content-Language",
    "Last-Event-ID",
  ],
  exposedHeaders: ["Content-Length", "X-JSON-Response-Size"],
  maxAge: 86400, // 24 hours
});

// ============================================
// HELMET SECURITY HEADERS
// ============================================
const devDirectives =
  process.env.NODE_ENV !== "production"
    ? {
        scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'", "blob:"],
        connectSrc: ["'self'", "ws://", "wss://", "blob:", "http://", "https://"],
      }
    : {};

export const helmetMiddleware = helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      scriptSrc: ["'self'", "blob:"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https:"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      frameSrc: ["'none'"],
      baseUri: ["'self'"],
      formAction: ["'self'"],
      frameAncestors: ["'none'"],
      upgradeInsecureRequests: process.env.NODE_ENV === "production" ? [] : undefined,
      ...devDirectives,
    },
  },
  crossOriginEmbedderPolicy: process.env.NODE_ENV === "production",
  crossOriginOpenerPolicy: true,
  crossOriginResourcePolicy: { policy: "cross-origin" },
  dnsPrefetchControl: true,
  frameguard: { action: "deny" },
  hidePoweredBy: true,
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true,
  },
  ieNoOpen: true,
  noSniff: true,
  permittedCrossDomainPolicies: false,
  referrerPolicy: { policy: "strict-origin-when-cross-origin" },
  xssFilter: true,
});

// ============================================
// RATE LIMITING
// ============================================
export const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: process.env.NODE_ENV === "production" ? 100 : 1000,
  message: "Too many requests from this IP, please try again later.",
  standardHeaders: true,
  legacyHeaders: false,
  skip: (req) => req.path === "/health",
});

export const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: "Too many authentication attempts, please try again later.",
  standardHeaders: true,
  legacyHeaders: false,
  skipSuccessfulRequests: true,
});

export const uploadLimiter = rateLimit({
  windowMs: 60 * 60 * 1000,
  max: 20,
  message: "Too many file uploads, please try again later.",
  standardHeaders: true,
  legacyHeaders: false,
});

// ============================================
// INPUT SANITIZATION
// ============================================
export function sanitizeInput(input: string): string {
  if (!input) return "";
  return input
    .trim()
    .replace(/[<>]/g, "")
    .replace(/javascript:/gi, "")
    .replace(/on\\w+=/gi, "");
}

export function normalizeEmail(email: string): string {
  return email.toLowerCase().trim();
}

export function isValidCountryCode(code: string): boolean {
  return /^[A-Z]{2}$/.test(code.toUpperCase());
}

const VALID_VISA_TYPES = [
  "tourist",
  "business",
  "student",
  "work",
  "skilled_worker",
  "family",
  "opportunity_card",
  "permanent_resident",
  "refugee",
  "other",
];

export function isValidVisaType(type: string): boolean {
  return VALID_VISA_TYPES.includes(type.toLowerCase());
}
EOFcat > server/middleware/security.ts <<'EOF'
import { Request, Response, NextFunction } from "express";
import helmet from "helmet";
import cors from "cors";
import rateLimit from "express-rate-limit";
import { logger } from "../lib/logger";

// ============================================
// CORS CONFIGURATION
// ============================================
function getAllowedOrigins(): string[] {
  if (!process.env.ALLOWED_ORIGINS) {
    const defaults = [
      "http://localhost:5000",
      "http://localhost:3000",
      "http://127.0.0.1:5000",
    ];

    if (process.env.NODE_ENV === "production") {
      logger.warn("ALLOWED_ORIGINS not set in production, using defaults", defaults);
    }

    return defaults;
  }

  return process.env.ALLOWED_ORIGINS.split(",").map((o) => o.trim());
}

const allowedOrigins = getAllowedOrigins();
logger.info({ allowedOrigins }, "CORS configured");

export const corsMiddleware = cors({
  origin: function (origin, callback) {
    // Allow requests with no origin (e.g. curl, same-origin file requests)
    if (!origin || origin === "null") {
      return callback(null, true);
    }

    try {
      const normalizedOrigin = origin.toLowerCase();

      const isAllowed = allowedOrigins.some((allowed) => {
        const normalizedAllowed = allowed.toLowerCase();
        if (normalizedAllowed === normalizedOrigin) return true;

        // Wildcard support: e.g. *.example.com
        if (normalizedAllowed.includes("*")) {
          const pattern = new RegExp(
            "^" + normalizedAllowed.replace(/\./g, "\\.").replace(/\*/g, ".*") + "$"
          );
          return pattern.test(normalizedOrigin);
        }

        return false;
      });

      if (isAllowed) {
        return callback(null, true);
      }

      logger.warn({ origin }, "CORS origin not allowed");
      // In production, consider rejecting; to avoid accidental blocking allow it
      if (process.env.NODE_ENV === "production") {
        // allow anyway (safer for deployment) — change to callback(new Error(...)) to enforce
        return callback(null, true);
      } else {
        return callback(new Error("Not allowed by CORS"));
      }
    } catch (err) {
      logger.error({ err, origin }, "Error in CORS origin check");
      return callback(new Error("CORS check failed"));
    }
  },
  credentials: true,
  methods: ["GET", "HEAD", "PUT", "PATCH", "POST", "DELETE", "OPTIONS"],
  allowedHeaders: [
    "Content-Type",
    "Authorization",
    "X-Requested-With",
    "Accept",
    "Accept-Language",
    "Content-Language",
    "Last-Event-ID",
  ],
  exposedHeaders: ["Content-Length", "X-JSON-Response-Size"],
  maxAge: 86400, // 24 hours
});

// ============================================
// HELMET SECURITY HEADERS
// ============================================
const devDirectives =
  process.env.NODE_ENV !== "production"
    ? {
        scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'", "blob:"],
        connectSrc: ["'self'", "ws://", "wss://", "blob:", "http://", "https://"],
      }
    : {};

export const helmetMiddleware = helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      scriptSrc: ["'self'", "blob:"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https:"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      frameSrc: ["'none'"],
      baseUri: ["'self'"],
      formAction: ["'self'"],
      frameAncestors: ["'none'"],
      upgradeInsecureRequests: process.env.NODE_ENV === "production" ? [] : undefined,
      ...devDirectives,
    },
  },
  crossOriginEmbedderPolicy: process.env.NODE_ENV === "production",
  crossOriginOpenerPolicy: true,
  crossOriginResourcePolicy: { policy: "cross-origin" },
  dnsPrefetchControl: true,
  frameguard: { action: "deny" },
  hidePoweredBy: true,
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true,
  },
  ieNoOpen: true,
  noSniff: true,
  permittedCrossDomainPolicies: false,
  referrerPolicy: { policy: "strict-origin-when-cross-origin" },
  xssFilter: true,
});

// ============================================
// RATE LIMITING
// ============================================
export const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: process.env.NODE_ENV === "production" ? 100 : 1000,
  message: "Too many requests from this IP, please try again later.",
  standardHeaders: true,
  legacyHeaders: false,
  skip: (req) => req.path === "/health",
});

export const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: "Too many authentication attempts, please try again later.",
  standardHeaders: true,
  legacyHeaders: false,
  skipSuccessfulRequests: true,
});

export const uploadLimiter = rateLimit({
  windowMs: 60 * 60 * 1000,
  max: 20,
  message: "Too many file uploads, please try again later.",
  standardHeaders: true,
  legacyHeaders: false,
});

// ============================================
// INPUT SANITIZATION
// ============================================
export function sanitizeInput(input: string): string {
  if (!input) return "";
  return input
    .trim()
    .replace(/[<>]/g, "")
    .replace(/javascript:/gi, "")
    .replace(/on\\w+=/gi, "");
}

export function normalizeEmail(email: string): string {
  return email.toLowerCase().trim();
}

export function isValidCountryCode(code: string): boolean {
  return /^[A-Z]{2}$/.test(code.toUpperCase());
}

const VALID_VISA_TYPES = [
  "tourist",
  "business",
  "student",
  "work",
  "skilled_worker",
  "family",
  "opportunity_card",
  "permanent_resident",
  "refugee",
  "other",
];

export function isValidVisaType(type: string): boolean {
  return VALID_VISA_TYPES.includes(type.toLowerCase());
}
