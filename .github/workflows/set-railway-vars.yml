name: Set Railway Environment Variables

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  set-vars:
    name: Set Railway Variables
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Login to Railway
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          if [ -z "$RAILWAY_API_TOKEN" ]; then echo "RAILWAY_API_TOKEN secret is required"; exit 1; fi
          railway login --apiKey "$RAILWAY_API_TOKEN"

      - name: Set variables from secret
        env:
          RAILWAY_VARS: ${{ secrets.RAILWAY_VARS }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          if [ -z "$RAILWAY_PROJECT_ID" ]; then echo "RAILWAY_PROJECT_ID secret is required"; exit 1; fi
          if [ -z "$RAILWAY_VARS" ]; then echo "RAILWAY_VARS secret is empty - nothing to set"; exit 0; fi

          echo "Setting Railway variables for project: $RAILWAY_PROJECT_ID"
          echo "$RAILWAY_VARS" | tr '\r' '\n' | while IFS= read -r line || [ -n "$line" ]; do
            # skip empty lines and comments
            [[ -z "$line" || "$line" =~ ^# ]] && continue
            KEY="$(echo "$line" | cut -d'=' -f1)"
            VALUE="$(echo "$line" | cut -d'=' -f2- )"
            if [ -z "$KEY" ]; then continue; fi
            echo "Setting $KEY"
            railway variables set "$KEY" "$VALUE" --project "$RAILWAY_PROJECT_ID" || { echo "Failed to set $KEY"; exit 1; }
          done

      - name: List variables (verification)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "Listing vars for project $RAILWAY_PROJECT_ID"
          railway variables --project "$RAILWAY_PROJECT_ID" || true
